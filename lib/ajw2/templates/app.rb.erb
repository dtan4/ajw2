<%- @databases.render_definition.each do |definition| -%>
<%= definition %>
<%- end -%>
class App < Sinatra::Base
  configure do
    register Sinatra::ActiveRecordExtension
    set :sockets, []
    use Rack::Session::Cookie, expire_after: 3600, secret: "salt"
    use Rack::Csrf, raise: true
    Slim::Engine.default_options[:pretty] = true
  end

  helpers do
    def csrf_meta_tag
      Rack::Csrf.csrf_metatag(env)
    end
  end

  get "/" do
    if !request.websocket?
      slim :index
    else
      request.websocket do |ws|
        ws.onopen do
          settings.sockets << ws
        end

        ws.onmessage do |msg|
          _ws_json = JSON.parse(msg, symbolize_names: true)
          params = _ws_json[:params]
          response = {}
<%- if @events.render_rb_realtime.length > 0 -%>
          case _ws_json[:func]
<%- @events.render_rb_realtime.each do |rb| -%>
<%= indent(rb, 5) %>
<%- end -%>
          else
          end
<%- end -%>
        end

        ws.onclose do
          settings.sockets.delete(ws)
        end
      end
    end
  end

<%- @events.render_rb_ajax.each do |rb| -%>
<%= indent(rb, 1) %>
<%- end -%>
end
